#!/bin/bash

APP_PORT=${PORT:-8087}

set -e
set -x

cd /app
source /venv/bin/activate

# Use environment variables if set, fallback to hardcoded values
DB_HOST=${DB_HOST:-dpg-d487qj4hg0os7383vib0-a.oregon-postgres.render.com}
DB_PORT=${DB_PORT:-5432}

echo "Waiting for Postgres at ${DB_HOST}:${DB_PORT}..."

# Loop until Postgres is ready
until pg_isready "postgresql://${DB_HOST}:${DB_PORT}" >/dev/null 2>&1; do
    echo "Waiting for Postgres..."
    sleep 1
done

echo "Postgres is ready!"

# Run migrations if the migrate script exists
if [ -f /app/migrate ]; then
    echo "Running migrations..."
    bash /app/migrate
fi

# Start Gunicorn
exec /venv/bin/gunicorn --worker-tmp-dir /dev/shm alx_travel_app.wsgi:application --bind "0.0.0.0:${APP_PORT}"
